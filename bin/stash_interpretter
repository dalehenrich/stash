#!/usr/bin/env bash
#
#	command line interpretter for stash script
#	
#	arguments up to the first -- are interpreted as arguments to 
#		$GS_HOME/bin/startTopaz.
#	arguments after the first -- are passed to the smalltalk
#		command-line interpreter
#

stashFile=`realpath $1`
pwd=`pwd`
shift
topazArgs=""
stashArgs=""
doneTopaz="false"
for argument in $* ; do
#	echo "===>$argument"
	if [ "$argument" = "--" ] ; then
		doneTopaz="true"
	else
		if [ "${doneTopaz}" = "true" ] ; then
			stashArgs="$stashArgs $argument"
		else
			topazArgs="$topazArgs $argument"
		fi
	fi
done

#	echo "topaz args: $topazArgs"
#	echo "stash args: $stashArgs"

file=`mktemp`

cat - > $file << EOF

! display pauseonerror

	login

	print
	| projectDefinition scriptClassDefinition stashFile stash |
	stashFile := '$stashFile'.
	projectDefinition := Rowan classTools stashClassLoadTool 
		loadTonelClassFile: stashFile.
	scriptClassDefinition := (projectDefinition packages values any) classDefinitions values any.
	stash := (System myUserProfile symbolList objectNamed: scriptClassDefinition name) 
		stashFilePath: stashFile 
		topazArgs: '$topazArgs' 
		stashArgs: '$stashArgs' 
		workingDir: '$pwd'.
	stash executeScript
%

	exit

EOF

# echo $file
#	$GS_HOME/bin/startTopaz $topazArgs

$GS_HOME/bin/startTopaz $topazArgs < $file
