#!/usr/bin/env bash
#
#	command line interpretter for smalltalk script GemStone 3.5.0 and beyond
#	
#	arguments up to the first -- are interpreted as arguments to 
#		command-line interpreter
#	arguments after the first -- are passed to the smalltalk
#		$GS_HOME/bin/startTopaz.
#

#	echo "0: $@"
stashFile=`realpath $1`
shift

solo=""
topazArgs="$GEMSTONE_SCRIPT_ARGS"
if [ "$1" = "-S" ] ; then
	# hack .. for now
	solo="set solologin on"
	topazArgs="$GEMSTONE_SOLO_SCRIPT_ARGS"
	shift
fi

pwd=`pwd`
# StashScript class will do it's own parsing of the command line args (in Smalltalk)
#		just stripping out topaz arguments
stashArgs="$*" 
startTopaz="false"
#	echo "1: $@"
for argument in $@ ; do
	echo "===>$argument"
	if [ "$argument" = "--" ] ; then
		startTopaz="true"
		topazArgs=""
	else
		if [ "${startTopaz}" = "true" ] ; then
			topazArgs+=" $argument"
		fi
	fi
done

#	echo "topaz args: $topazArgs"
#	echo "stash args: $stashArgs"

file=`mktemp`
cat - > $file << EOF
	iferr 1 stk

	$solo
	login

	run
	| result |
	result := StashScript
			loadAndExecuteScriptClassFile: '$stashFile'
			stashArgs: '$stashArgs'
			topazArgs: '$topazArgs'
			workingDir: '$pwd'
			projectName: '__EXECUTE_STASH_SCRIPT_PROJECT__'
			packageName: '__EXECUTE_STASH_SCRIPT_PACKAGE__'
			symDictName: '_EXECUTE_STASH_SCRIPT_SymbolDict__'.
	GsFile stdout nextPutAll: result asString; lf
%
EOF

if [ "${topazArgs}x" = "x" ] ; then
	echo "missing startTopaz command line args (stoneName -lq)"
	echo "	export GEMSTONE_SCRIPT_ARGS=\"<stone-name> -lq\""
	exit 1
fi

$GS_HOME/bin/scriptTopaz $topazArgs -S $file
